<!DOCTYPE html>
<html style="background-color: #ECFAFB;">
	<head>
		<title>百萬彈幕</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<!-- bootstrap -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
		
		<!-- swiper cdn-->
        <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.css">
        <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">

		<!--meta name="Ching-Hong Fang">
		<meta name="description" content="coding101 "-->
	</head>
	<body style="background-color: #ECFAFB;">
		<style>
			body{
				box-sizing: border-box;
			}
			h2{
				text-align: center;
			}
			.swiper-container{
				width: 90%;
				height: 100px;
			}
			.swiper-row{
				width: 90%;
				height: 100px;
			}
			.symbol {
				color: #4AA6B5;
				background-color: #ECFAFB;
				border:0px;
			}
			.color_img{
				width: 25px;
			}
		</style>
		
		<div class="container">
			<div class="row">
				<div class="col-md-6">
					<div class="container">
						<div class="row justify-content-center">
							<div class="col-sm-4 panel-item">
								<h2><b>百萬彈幕</b></h2>
							</div>
						</div>
					</div>
			
					<div class="d-flex">
						<div class="input-group mb-3" style="padding:5% 5% 0 5%">
							<input type="text" class="form-control" id="ans" onclick=change_pos() placeholder="" aria-label="Recipient's username" aria-describedby="button-addon2">
							<div class="input-group-append">
								<button type="button" class="close" onclick=clean() aria-label="Close">
									<span class="input-group-text" aria-hidden="true">&times;</span>
								</button>
								<input type="image" style="width:40px; height:40px;" onclick=Go() src="https://raw.githubusercontent.com/chinghongfang/html_practice/master/image/client2.png"></input>
							</div>
						</div>
					</div>
					<div style="text-align:center;"><h4 id="warningMsg" style="color:red; padding: 0 5% 0 5%;"></h4></div>
					
					<div class="swiper-container">
						<div class="swiper-wrapper">
							<div class="swiper-slide">
								<div class="swiper-row">
									<!-- Additional required wrapper -->
									<div class="swiper-wrapper" style="vertical-align:middle">
										<!-- Slides -->
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("贊同")>贊同</button>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("反對")>反對</button></br>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("老師可以講慢一點嗎")>老師可以講慢一點嗎</button></br>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("可以再講一次嗎")>可以再講一次嗎</button></br>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("選項(1)")>選項(1)</button>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("選項(2)")>選項(2)</button>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("選項(3)")>選項(3)</button></br>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("選項(4)")>選項(4)</button>
											</div>
										<div class="swiper-slide">
											<button type="button" class="symbol" onclick=symbol("冷氣好冷")>冷氣好冷</button></br>
											</div>
									</div>
								</div>
							</div>
							<div class="swiper-slide">
								<div class="symbol-btn">
									<button type="button" class="symbol" title="積分" onclick=symbol("∫")>∫</button>
									<button type="button" class="symbol" title="環積分" onclick=symbol("∮")>∮</button>
									<button type="button" class="symbol" title="dx" onclick=symbol("dx")>dx</button>
									<button type="button" class="symbol" title="Sigma" onclick=symbol("∑()")>∑</button>
									<button type="button" class="symbol" title="圓周率" onclick=symbol("π")>π</button>
									<button type="button" class="symbol" title="極限" onclick=symbol("lim")>lim</button>
									<button type="button" class="symbol" title="正弦" onclick=symbol("sin()")>sin</button>
									<button type="button" class="symbol" title="餘弦" onclick=symbol("cos()")>cos</button>
									<button type="button" class="symbol" title="正切" onclick=symbol("tan()")>tan</button>
									<button type="button" class="symbol" title="餘切" onclick=symbol("cot()")>cot</button>
									<button type="button" class="symbol" title="正割" onclick=symbol("sec()")>sec</button>
									<button type="button" class="symbol" title="餘割" onclick=symbol("csc()")>csc</button>
									
									<button type="button" class="symbol" title="正負" onclick=symbol("±")>±</button>
									<button type="button" class="symbol" title="無限" onclick=symbol("∞")>∞</button>
									<button type="button" class="symbol" title="不等於" onclick=symbol("≠")>≠</button>
									<button type="button" class="symbol" title="小於等於"onclick=symbol("≤")>≤</button>
									<button type="button" class="symbol" title="大於等於" onclick=symbol("≥")>≥</button>
									<button type="button" class="symbol" title="約等於" onclick=symbol("≈")>≈</button>
									<button type="button" class="symbol" title="等價" onclick=symbol("≡")>≡</button>
									<button type="button" class="symbol" title="partial" onclick=symbol("∂")>∂</button>
									<button type="button" class="symbol" title="開根" onclick=symbol("√")>√</button>
									<button type="button" class="symbol" title="聯集" onclick=symbol("∪")>∪</button>
									<button type="button" class="symbol" title="交集" onclick=symbol("∩")>∩</button>
									<button type="button" class="symbol" title="delta" onclick=symbol("∆")>∆</button>
									<button type="button" class="symbol" title="趨近" onclick=symbol("→")>→</button>
									<button type="button" class="symbol" title="因為" onclick=symbol("∵")>∵</button>
									<button type="button" class="symbol" title="所以" onclick=symbol("∴")>∴</button>
									<!--
									<button type="button" class="symbol" onclick=symbol("α")>α</button>
									<button type="button" class="symbol" onclick=symbol("β")>β</button>
									<button type="button" class="symbol" onclick=symbol("γ")>γ</button>
									<button type="button" class="symbol" onclick=symbol("δ")>δ</button>
									<button type="button" class="symbol" onclick=symbol("ε")>ε</button>
									<button type="button" class="symbol" onclick=symbol("ϵ")>ϵ</button>
									<button type="button" class="symbol" onclick=symbol("θ")>θ</button>
									<button type="button" class="symbol" onclick=symbol("ϑ")>ϑ</button>
									<button type="button" class="symbol" onclick=symbol("μ")>μ</button>
									<button type="button" class="symbol" onclick=symbol("π")>π</button>
									<button type="button" class="symbol" onclick=symbol("ρ")>ρ</button>
									<button type="button" class="symbol" onclick=symbol("σ")>σ</button>
									<button type="button" class="symbol" onclick=symbol("τ")>τ</button>
									<button type="button" class="symbol" onclick=symbol("φ")>φ</button>
									<button type="button" class="symbol" onclick=symbol("ω")>ω</button>
									-->
								</div>
							</div>
						</div>
					</div>
					
					<div class="container" style="padding:10% 0% 5% 5%">
						<div class="row">
							<div class="col-auto">
								顏色：
							</div>
							<div class="col">
								<label>
									<input class="rad" type="radio" name="color" value="red" checked>
									<image class="color_img" src="https://raw.githubusercontent.com/chinghongfang/html_practice/master/image/red.png">
								</label>
								<label>
									<input class="rad" type="radio" name="color" value="white">
									<image class="color_img" src="https://raw.githubusercontent.com/chinghongfang/html_practice/master/image/white.png">
								</label>
								<label>
									<input class="rad" type="radio" name="color" value="Grass">
									<image class="color_img" src="https://raw.githubusercontent.com/chinghongfang/html_practice/master/image/green.png">
								</label>
								<label>
									<input class="rad" type="radio" name="color" value="Blue">
									<image class="color_img" src="https://raw.githubusercontent.com/chinghongfang/html_practice/master/image/light_blue.png">
								</label>
							</div>
						</div>
					</div>
				</div>
				
				<!-- 聊天室 block -->
				<div class="col-md-6 align-self-end" style="padding:5%;">
					<nav id="navbar-example2" class="navbar navbar-light bg-light rounded">
						<ul class="nav nav-pills">
							<li class="nav-item">
								<h4>聊天室</h4>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#top">置頂</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#bot">置底</a>
							</li>
						</ul>
					</nav>
					<div class="shadow rounded" style="overflow-y: scroll;height:200px; background-color: #81CBC8;"onmouseover="mouseOver()" onmouseout="mouseOut()" ontouchstart="mouseOver()" ontouchend="mouseOut()">
						<div id="room" data-spy="scroll" data-target="#navbar-example2" data-offset="0">
							<h4 id="top"></h4>
							<h4 id="bot"></h4>
						</div>
					</div>
				</div>
			</div>
		</div>
		<footer class="nav-fixed-bottom">
			<div class="container">
				<div class="d-flex flex-row-reverse" >
					<span class="text-muted"style="text-align:left">Designed by 鮪魚蛋土司</span>
				</div>
			</div>
		</footer>
		
		
		<script>
			var pos = 0;		// the position to enter words in the send-box
			var on_room = false;	// on mouse over boolean value
			function change_pos(){
				pos = document.getElementById('ans').selectionStart;
				document.getElementById("warningMsg").innerHTML = "";
			}
			function symbol(data){
				let head = document.getElementById('ans').value.slice(0,pos)
				let tail = document.getElementById('ans').value.slice(pos)
				pos += data.length
				document.getElementById('ans').value = head.concat(data.concat(tail));
			}
			function clean(){
				document.getElementById('ans').value = "";
				document.getElementById("warningMsg").innerHTML = "";
			}
			function getText(){
				return document.getElementById('ans').value;
			}
			function mouseOver(){
				on_room = true;
			}
			function mouseOut(){
				on_room = false;
			}
			
			// execute Go() function when pressing enter and focusing on input box
			document.getElementById("ans").addEventListener("keyup", function(event){
				// 13 is the code of enter key
				if (event.keyCode === 13){
					// Cancel the default action
					event.preventDefault();
					Go();
				}
			});
			
			// Try to get the web url
			// the url may be: https://123456#top || https://123456#bot || https://123456
			// and we want https123456 to be our web_head
			let len = location.href.search("#");	
			if (len != -1){
				len -= 1;
			}
			var web_head = location.href.slice(0, len);
			web_head = web_head.replace(/\//g,'');
			web_head = web_head.replace(/:/g,'');
			web_head = web_head.replace(/\./g,'');
		</script>
		
		<!-- bootstrap script -->
		<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
		
		<!-- swiper script -->
        <script src="https://unpkg.com/swiper/swiper-bundle.js"></script>
        <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
		<script type="module">
            import Swiper from 'https://unpkg.com/swiper/swiper-bundle.esm.browser.min.js'
			const rowSwiper = new Swiper('.swiper-container', {
				direction: 'horizontal',
				loop: false,
				slidesPerView: 1,
			})
			const mySwiper = new Swiper ('.swiper-row', {
				// Optional parameters
				direction: 'vertical',//'horizontal',
				loop: false,
				slidesPerView: 4,
				spaceBetween: 5,
			})
		</script>
		
		<!-- firebase -->
		<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase.js"></script>
			<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
		<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-analytics.js"></script>
			<!-- Add Firebase products that you want to use -->
		<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-auth.js"></script>
		<script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-firestore.js"></script>
		<script>
			// Your web app's Firebase configuration
			var firebaseConfig = {
				apiKey: "AIzaSyBF2uPeIMPhyrmUyKfvTy9n7WkOSI85zmg",
				authDomain: "practice-2334f.firebaseapp.com",
				databaseURL: "https://practice-2334f.firebaseio.com",
				projectId: "practice-2334f",
				storageBucket: "practice-2334f.appspot.com",
				messagingSenderId: "906379530813",
				appId: "1:906379530813:web:f36ce20044f9c8f7111054",
				measurementId: "G-NK01QHSFQT"
			};
			// Initialize Firebase
			firebase.initializeApp(firebaseConfig);
			firebase.analytics();
			// Get a reference to the database service
			var database = firebase.database();
			
			/* ******** For chatroom *******************************************/
			firebase.database().ref('/chatroom').once('value').then(function(snapshot) {
				//console.log(snapshot.val());
				// to check if the room exists
				if (snapshot.val().hasOwnProperty(web_head)){
					return;
				}
				firebase.database().ref('/chatroom/'+web_head).set({1234:1});
			});
			
			function updateroom(time_stamp){
				time_stamp = time_stamp[web_head];
				let keys = Object.keys(time_stamp);
				let all_text = "";
				keys.forEach(function(key){
					if (time_stamp[key]["message"]){
						all_text += "<p>"+time_stamp[key]["message"]+"</p>";
					}
				});
				document.getElementById("room").innerHTML = "<h4 id='top'></h4>"+ all_text + "<h4 id='bot'></h4>";
				if (!on_room){location.href = "#bot";}
			}
			var chatroomRef = firebase.database().ref('/chatroom/');
			chatroomRef.on('value', function(snapshot) {
				updateroom(snapshot.val());
			});
			/* ******** For chatroom *******************************************/
			
			/* ******** For sending message to server and firebase *************/
			function Go(){
				let text_to_send = document.getElementById('ans').value
				if (text_to_send.length > 20){
					document.getElementById("warningMsg").innerHTML = "不能超過20字";
					return;
				}else if (text_to_send.length == 0){
					return;
				}
				
				handleClick()
				
				document.getElementById('ans').value = "";
				// send something to server
				var d = new Date();
				let time = d.getTime();
				
				// get color radio box
				let colors = document.getElementsByName('color');
				let color;
				for (let i = 0; i< colors.length; ++i){
					if (colors[i].checked){
						color = colors[i].value;
						break;
					}
				}
				
				firebase.database().ref('/chatroom/'+web_head+'/'+time).set({
					message: text_to_send,
					color:	color
				});
				
			}
			const handleClick=()=>{
				// get color radio box
				let colors = document.getElementsByName('color');
				let color;
				for (let i = 0; i< colors.length; ++i){
					if (colors[i].checked){
						color = colors[i].value;
						break;
					}
				}

				var data={text:getText(), color:color};

    			fetch( '/response',{
					method:"POST",
					body:JSON.stringify(data),
					headers: new Headers({
            					'Content-Type': 'application/json'
        				})
					 })
    			.then(res => res.json())
    			.then(data => {//i know
          			
    			})
    			.catch(e => {
        			console.log(e);
    			})
			}
		</script>
		
	</body>
</html>
